name: Build chip-tool

on:
  push:
    branches: [ main ]
    paths:
      - .github/workflows/build.yml
  workflow_dispatch:

env:
  CHIP_REF: v1.4.2.0

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest]
        arch: [x64 , arm64]
        exclude:
          - os: macos-latest
            arch: x64  # macos-latest runner is x64 only
          - os: ubuntu-latest
            arch: arm64  # macos-latest runner is x64 only
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Cache chip-tool build
        uses: actions/cache@v4
        with:
          path: connectedhomeip/out/chip-tool
          key: chip-tool-${{ runner.os }}-${{ env.CHIP_REF }}-${{ hashFiles('connectedhomeip/**') }}
          restore-keys: |
            chip-tool-${{ runner.os }}-${{ env.CHIP_REF }}-


      - name: Checkout connectedhomeip 
        uses: actions/checkout@v4
        with:
          repository: project-chip/connectedhomeip
          ref: refs/tags/${{ env.CHIP_REF }}
          path: connectedhomeip

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: brew install python ninja llvm

      - name: Install dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt-get update && sudo apt-get install -y git gcc g++ pkg-config libssl-dev libdbus-1-dev libglib2.0-dev libavahi-client-dev python3-venv python3-virtualenv python3-dev python3-pip unzip libgirepository1.0-dev libcairo2-dev libreadline-dev libgif-dev cmake ninja-build

      # For Linux arm64, set up QEMU for cross-compilation
      # - name: Set up QEMU
      #   if: matrix.os == 'ubuntu-latest' && matrix.arch == 'arm64'
      #   uses: docker/setup-qemu-action@v3

      # Build step (adapt for your build system)
      - name: Build chip-tool
        run: |
          if [ "${{ matrix.os }}" = "ubuntu-latest" ] && [ "${{ matrix.arch }}" = "arm64" ]; then
            # Use cross-compiler or Docker for arm64
            echo "Cross-compiling for linux-arm64"
            # Example: use a Docker image or set CC/CXX to aarch64-linux-gnu-gcc
          elif [ "${{ matrix.os }}" = "macos-latest" ] && [ "${{ matrix.arch }}" = "arm64" ]; then
            echo "Building for ${{ matrix.os }} ${{ matrix.arch }}"
            # Normal build commands
            cd connectedhomeip
            ./scripts/checkout_submodules.py --shallow --platform darwin
            source scripts/activate.sh
            ./scripts/examples/gn_build_example.sh examples/chip-tool out/chip-tool
          elif [ "${{ matrix.os }}" = "ubuntu-latest" ] && [ "${{ matrix.arch }}" = "x64" ]; then
            echo "Building for ${{ matrix.os }} ${{ matrix.arch }}"
            # Normal build commands
            cd connectedhomeip
            ./scripts/checkout_submodules.py --shallow --platform linux
            source scripts/activate.sh
            ./scripts/examples/gn_build_example.sh examples/chip-tool out/chip-tool
          fi


      # Upload artifact
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: chip-tool-${{ matrix.os }}-${{ matrix.arch }}
          path: connectedhomeip/out/chip-tool/chip-tool
          if-no-files-found: error

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Create and push tag
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git tag ${{ env.CHIP_REF }}
          git push origin ${{ env.CHIP_REF }}

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.CHIP_REF }}
          release_name: Release ${{ env.CHIP_REF }}
          draft: false
          prerelease: false

      - name: Upload all binaries to release
        run: |
          ls -alR ./
          for file in ./artifacts/*; do
            echo "Uploading $file"
            gh release upload ${{ env.CHIP_REF }} "$file" --clobber
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


